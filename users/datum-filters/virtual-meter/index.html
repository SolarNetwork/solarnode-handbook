
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://solarnetwork.github.io/solarnode-handbook/users/datum-filters/virtual-meter/" rel="canonical"/>
<link href="../unchanged/" rel="prev"/>
<link href="../../solarflux/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.18" name="generator"/>
<title>Virtual Meter - SolarNode Handbook</title>
<link href="../../../assets/stylesheets/main.7e37652d.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../css/sn.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="amber" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#virtual-meter-datum-filter">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="SolarNode Handbook" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="SolarNode Handbook">
<img alt="logo" src="../../../images/solarnode-icon.svg"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            SolarNode Handbook
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Virtual Meter
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="amber" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="amber" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="SolarNode Handbook" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="SolarNode Handbook">
<img alt="logo" src="../../../images/solarnode-icon.svg"/>
</a>
    SolarNode Handbook
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    User Guide
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_1_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/">
<span class="md-ellipsis">
    Getting Started
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../setup-app/">
<span class="md-ellipsis">
    Setup App
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_3">
<span class="md-nav__icon md-icon"></span>
            Setup App
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/login/">
<span class="md-ellipsis">
    Login
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/home/">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_3_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../setup-app/settings/">
<span class="md-ellipsis">
    Settings
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_3_4" id="__nav_1_3_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_3_4_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_1_3_4">
<span class="md-nav__icon md-icon"></span>
            Settings
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/settings/components/">
<span class="md-ellipsis">
    Components
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/settings/services/">
<span class="md-ellipsis">
    Services
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/settings/datum-filters/">
<span class="md-ellipsis">
    Datum Filters
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/settings/datum-sources/">
<span class="md-ellipsis">
    Datum Sources
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/settings/logging/">
<span class="md-ellipsis">
    Logging
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/settings/op-modes/">
<span class="md-ellipsis">
    Operational Modes
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/settings/local-state/">
<span class="md-ellipsis">
    Local State
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/settings/backups/">
<span class="md-ellipsis">
    Backups
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_3_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../setup-app/system/">
<span class="md-ellipsis">
    System
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_3_5" id="__nav_1_3_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_3_5_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_1_3_5">
<span class="md-nav__icon md-icon"></span>
            System
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/system/certificates/">
<span class="md-ellipsis">
    Certificates
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/system/packages/">
<span class="md-ellipsis">
    Packages
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/system/host-aliases/">
<span class="md-ellipsis">
    Host Aliases
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/system/restart/">
<span class="md-ellipsis">
    Restart
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/system/reset/">
<span class="md-ellipsis">
    Reset
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_3_6" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../setup-app/tools/">
<span class="md-ellipsis">
    Tools
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_3_6" id="__nav_1_3_6_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_3_6_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_1_3_6">
<span class="md-nav__icon md-icon"></span>
            Tools
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/tools/controls/">
<span class="md-ellipsis">
    Controls
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/tools/command-console/">
<span class="md-ellipsis">
    Command Console
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/tools/metrics/">
<span class="md-ellipsis">
    Metrics
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-app/profile/">
<span class="md-ellipsis">
    Profile
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cli/">
<span class="md-ellipsis">
    Command Line Tool
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../datum/">
<span class="md-ellipsis">
    Datum
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_1_6" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    Datum Filters
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_6" id="__nav_1_6_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_1_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_6">
<span class="md-nav__icon md-icon"></span>
            Datum Filters
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../chain/">
<span class="md-ellipsis">
    Filter Chain
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../control-updater/">
<span class="md-ellipsis">
    Control Updater
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../downsample/">
<span class="md-ellipsis">
    Downsample
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../expression/">
<span class="md-ellipsis">
    Expression
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../join/">
<span class="md-ellipsis">
    Join
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../metric-harvester/">
<span class="md-ellipsis">
    Metric Harvester
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../op-mode/">
<span class="md-ellipsis">
    Operational Mode
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../parameter-expression/">
<span class="md-ellipsis">
    Parameter Expression
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../property/">
<span class="md-ellipsis">
    Property
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../pvlib/">
<span class="md-ellipsis">
    POAI Calculator
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../split/">
<span class="md-ellipsis">
    Split
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tariff/">
<span class="md-ellipsis">
    Tariff
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../throttle/">
<span class="md-ellipsis">
    Throttle
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../unchanged-property/">
<span class="md-ellipsis">
    Unchanged Property
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../unchanged/">
<span class="md-ellipsis">
    Unchanged
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Virtual Meter
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Virtual Meter
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#settings">
<span class="md-ellipsis">
      Settings
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-meter-settings">
<span class="md-ellipsis">
      Virtual Meter Settings
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-meter-expression-settings">
<span class="md-ellipsis">
      Virtual Meter Expression Settings
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#filter-parameters">
<span class="md-ellipsis">
      Filter parameters
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-meter-metadata">
<span class="md-ellipsis">
      Virtual meter metadata
    </span>
</a>
<nav aria-label="Virtual meter metadata" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#resetting-metadata">
<span class="md-ellipsis">
      Resetting metadata
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-meter-legacy-metadata">
<span class="md-ellipsis">
      Virtual meter legacy metadata
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#expressions">
<span class="md-ellipsis">
      Expressions
    </span>
</a>
<nav aria-label="Expressions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#expression-root-object">
<span class="md-ellipsis">
      Expression root object
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#expression-example-time-of-use-tariff-reading">
<span class="md-ellipsis">
      Expression example: time of use tariff reading
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../solarflux/">
<span class="md-ellipsis">
    SolarFlux
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_8" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../sysadmin/">
<span class="md-ellipsis">
    System Administration
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_8" id="__nav_1_8_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_8">
<span class="md-nav__icon md-icon"></span>
            System Administration
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../sysadmin/date-time/">
<span class="md-ellipsis">
    Date and Time
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sysadmin/networking/">
<span class="md-ellipsis">
    Networking
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sysadmin/packages/">
<span class="md-ellipsis">
    Package Maintenance
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sysadmin/solarnode-service/">
<span class="md-ellipsis">
    SolarNode Service
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sysadmin/solarssh/">
<span class="md-ellipsis">
    SolarSSH
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../networking/">
<span class="md-ellipsis">
    Networking
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../security-tokens/">
<span class="md-ellipsis">
    Security Tokens
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../remote-access/">
<span class="md-ellipsis">
    Remote Access
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../expressions/">
<span class="md-ellipsis">
    Expressions
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../local-state/">
<span class="md-ellipsis">
    Local State
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../metrics/">
<span class="md-ellipsis">
    Metrics
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../op-modes/">
<span class="md-ellipsis">
    Operational Modes
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../placeholders/">
<span class="md-ellipsis">
    Placeholders
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../configuration/">
<span class="md-ellipsis">
    Configuration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../settings/">
<span class="md-ellipsis">
    Settings Files
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../logging/">
<span class="md-ellipsis">
    Logging
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../recipes/">
<span class="md-ellipsis">
    Recipes
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Recipes
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../recipes/datum-filters/">
<span class="md-ellipsis">
    Datum Filters
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
            Datum Filters
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../recipes/datum-filters/main-filter-chain/">
<span class="md-ellipsis">
    Main Filter Chain
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../recipes/datum-filters/daily-limit-tracking/">
<span class="md-ellipsis">
    Daily Limit Tracking
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../recipes/datum-filters/peak-tracking/">
<span class="md-ellipsis">
    Peak Tracking
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../developers/">
<span class="md-ellipsis">
    Developer Guide
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Developer Guide
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../developers/osgi/">
<span class="md-ellipsis">
    Plugins
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            Plugins
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/osgi/manifest/">
<span class="md-ellipsis">
    Manifest
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/osgi/life-cycle/">
<span class="md-ellipsis">
    Life cycle
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/osgi/configuration-admin/">
<span class="md-ellipsis">
    Configuration Admin
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/osgi/blueprint/">
<span class="md-ellipsis">
    Blueprint
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/osgi/blueprint-compendium/">
<span class="md-ellipsis">
    Blueprint Compendium
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../developers/settings/">
<span class="md-ellipsis">
    Settings
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            Settings
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/settings/provider/">
<span class="md-ellipsis">
    Settings Provider
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/settings/specifier/">
<span class="md-ellipsis">
    Setting Specifier
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/settings/resource-handler/">
<span class="md-ellipsis">
    Setting Resource Handler
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/settings/singleton/">
<span class="md-ellipsis">
    Singleton Service
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/settings/factory/">
<span class="md-ellipsis">
    Factory Service
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
<span class="md-ellipsis">
    Services
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            Services
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/backup-manager/">
<span class="md-ellipsis">
    Backup Manager
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/closeable-service/">
<span class="md-ellipsis">
    Closeable Service
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/datum-data-source-poll-job/">
<span class="md-ellipsis">
    Datum Data Source Poll Job
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/datum-data-source/">
<span class="md-ellipsis">
    Datum Data Source
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/datum-db/">
<span class="md-ellipsis">
    Datum Database
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/datum-queue/">
<span class="md-ellipsis">
    Datum Queue
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/job-scheduler/">
<span class="md-ellipsis">
    Job Scheduler
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/placeholder-service/">
<span class="md-ellipsis">
    Placeholder Service
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/settings-db/">
<span class="md-ellipsis">
    Settings Database
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/settings-service/">
<span class="md-ellipsis">
    Settings Service
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/sql-database/">
<span class="md-ellipsis">
    SQL Database
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/task-executor/">
<span class="md-ellipsis">
    Task Executor
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../developers/services/task-scheduler/">
<span class="md-ellipsis">
    Task Scheduler
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#settings">
<span class="md-ellipsis">
      Settings
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-meter-settings">
<span class="md-ellipsis">
      Virtual Meter Settings
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-meter-expression-settings">
<span class="md-ellipsis">
      Virtual Meter Expression Settings
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#filter-parameters">
<span class="md-ellipsis">
      Filter parameters
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-meter-metadata">
<span class="md-ellipsis">
      Virtual meter metadata
    </span>
</a>
<nav aria-label="Virtual meter metadata" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#resetting-metadata">
<span class="md-ellipsis">
      Resetting metadata
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-meter-legacy-metadata">
<span class="md-ellipsis">
      Virtual meter legacy metadata
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#expressions">
<span class="md-ellipsis">
      Expressions
    </span>
</a>
<nav aria-label="Expressions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#expression-root-object">
<span class="md-ellipsis">
      Expression root object
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#expression-example-time-of-use-tariff-reading">
<span class="md-ellipsis">
      Expression example: time of use tariff reading
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="virtual-meter-datum-filter"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.</span> Virtual Meter Datum Filter<a class="headerlink" href="#virtual-meter-datum-filter" title="Permanent link">¶</a></h1>
<p>The <a href="https://github.com/SolarNetwork/solarnetwork-node/blob/develop/net.solarnetwork.node.datum.filter.standard/README-VirtualMeter.md">Virtual Meter Datum Filter</a> provides a way to derive an accumulating "meter reading" value
out of an instantaneous property value over time. For example, if you have an irradiance sensor that
allows you to capture instantaneous W/m<sup>2</sup> power values, you could configure a virtual meter to
generate Wh/m<sup>2</sup> energy values.</p>
<p>Each virtual meter works with a single input datum property, typically an instantaneous property.
The derived accumulating datum property will be named after that property with the time unit suffix
appended. For example, an instantaneous <code>irradiance</code> property using the <code>Hours</code> time unit would
result in an accumulating <code>irradianceHours</code> property. The value is calculated as an <strong>average</strong>
between the <em>current</em> and the <em>previous</em> instantaneous property values, multiplied by the amount of
time that has elapsed between the two samples.</p>
<p>This filter is provided by the <a href="https://github.com/SolarNetwork/solarnetwork-node/blob/develop/net.solarnetwork.node.datum.filter.standard/">Standard Datum Filters</a> plugin.</p>
<h2 id="settings"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.1</span> Settings<a class="headerlink" href="#settings" title="Permanent link">¶</a></h2>
<figure>
<p><img alt="Virtual Meter Datum filter component settings" loading="lazy" src="../../../images/users/datum-filters/virtual-meter-filter-settings%402x.png" width="722"/></p>
</figure>
<p>In addition to the <a href="../#common-datum-filter-settings">Common Settings</a>, the following general settings are available:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Setting</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Virtual Meters</td>
<td style="text-align: left;">Configure as many virtual meters as you like, using the <span class="keys"><kbd class="key-plus">+</kbd></span> and <span class="keys"><kbd class="key-minus">-</kbd></span> buttons to add/remove meter configurations.</td>
</tr>
</tbody>
</table>
<h2 id="virtual-meter-settings"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.2</span> Virtual Meter Settings<a class="headerlink" href="#virtual-meter-settings" title="Permanent link">¶</a></h2>
<p>The Virtual Meter settings define a single virutal meter.</p>
<figure>
<p><img alt="Virtual Meter Datum filter meter settings" loading="lazy" src="../../../images/users/datum-filters/virtual-meter-filter-meter-settings%402x.png" width="592"/></p>
</figure>
<table>
<thead>
<tr>
<th style="text-align: left;">Setting</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Property</td>
<td style="text-align: left;">The name of the <strong>input</strong> datum property to derive the virtual meter values from.</td>
</tr>
<tr>
<td style="text-align: left;">Property Type</td>
<td style="text-align: left;">The type of the <strong>input</strong> datum property. Typically this will be <code>Instantaneous</code> but when combined with an expression an <code>Accumulating</code> property can be used.</td>
</tr>
<tr>
<td style="text-align: left;">Reading Property</td>
<td style="text-align: left;">The name of the <strong>output</strong> meter accumulating datum property to generate. Leave empty for a default name derived from <strong>Property</strong> and <strong>Time Unit</strong>. For example, an instantaneous <code>irradiance</code> property using the <code>Hours</code> time unit would result in an accumulating <code>irradianceHours</code> property.</td>
</tr>
<tr>
<td style="text-align: left;">Time Unit</td>
<td style="text-align: left;">The time unit to record meter readings as. This value affects the name of the virtual meter reading property if <strong>Reading Property</strong> is left blank: it will be appended to the end of <strong>Property Name</strong>. It also affects the virtual meter output reading values, as they will be calculated in this time unit.</td>
</tr>
<tr>
<td style="text-align: left;">Max Age</td>
<td style="text-align: left;">The maximum time allowed between samples where the meter reading can advance. In case the node is not collecting samples for a period of time, this setting prevents the plugin from calculating an unexpectedly large reading value jump. For example if a node was turned off for a day, the first sample it captures when turned back on would otherwise advance the reading as if the associated instantaneous property had been active over that entire time. With this restriction, the node will record the new sample date and value, but not advance the meter reading until another sample is captured within this time period.</td>
</tr>
<tr>
<td style="text-align: left;">Decimal Scale</td>
<td style="text-align: left;">A maximum number of digits after the decimal point to round to. Set to <code>0</code> to round to whole numbers.</td>
</tr>
<tr>
<td style="text-align: left;">Track Only On Change</td>
<td style="text-align: left;">When enabled, then only update the previous reading date if the new reading value differs from the previous one.</td>
</tr>
<tr>
<td style="text-align: left;">Rolling Average Count</td>
<td style="text-align: left;">A count of samples to average the property value from. When set to something greater than <code>1</code>, then apply a rolling average of this many property samples and output that value as the <em>instantaneous</em> source property value. This has the effect of smoothing the instantaneous values to an average over the  time period leading into each output sample. Defaults to <code>0</code> so no rolling average is applied.</td>
</tr>
<tr>
<td style="text-align: left;">Add Instantaneous Difference</td>
<td style="text-align: left;">When enabled, then include an <strong>output</strong> instantaneous property of the difference between the current and previous reading values.</td>
</tr>
<tr>
<td style="text-align: left;">Instantaneous Difference Property</td>
<td style="text-align: left;">The derived <strong>output</strong> instantaneous datum property name to use when <strong>Add Instantaneous Difference</strong> is enabled. By default this property will be derived from the <strong>Reading Property</strong> value with <code>Diff</code> appended.</td>
</tr>
<tr>
<td style="text-align: left;">Reading Value</td>
<td style="text-align: left;">You can reset the virtual meter reading value with this setting. <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:"/> <strong>Note</strong> this is an advanced operation. If you submit a value for this setting, the virtual meter reading will be reset to this value such that the next datum the reading is calculated for will use this as the current meter reading. This will impact the datum stream's reported aggregate values, so you should be very sure this is something you want to do. For example if the virtual meter was at <code>1000</code> and you reset it <code>0</code> then that will appear as a <code>-1000</code> drop in whatever the reading is measuring. If this occurs you can create a <code>Reset</code> <a href="https://github.com/SolarNetwork/solarnetwork/wiki/SolarNet-API-global-objects#datum-auxiliary">Datum auxiliary record</a> to accomodate the reset value.</td>
</tr>
<tr>
<td style="text-align: left;">Expressions</td>
<td style="text-align: left;">Configure as many expressions as you like, using the <span class="keys"><kbd class="key-plus">+</kbd></span> and <span class="keys"><kbd class="key-minus">-</kbd></span> buttons to add/remove <a href="#virtual-meter-expression-settings">expression configurations</a>.</td>
</tr>
</tbody>
</table>
<h2 id="virtual-meter-expression-settings"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.3</span> Virtual Meter Expression Settings<a class="headerlink" href="#virtual-meter-expression-settings" title="Permanent link">¶</a></h2>
<p>A virtual meter can use expressions to customise how the output meter value reading value is
calculated. See the <a href="#expressions">Expressions</a> section for more information.</p>
<figure>
<p><img alt="Virtual Meter Datum filter expression settings" loading="lazy" src="../../../images/users/datum-filters/virtual-meter-filter-expression-settings%402x.png" width="665"/></p>
</figure>
<table>
<thead>
<tr>
<th style="text-align: left;">Setting</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Property</td>
<td style="text-align: left;">The datum property to store the expression result in. This must match the <strong>Reading Property</strong> of a <a href="#virtual-meter-settings">meter configuration</a>. Keep in mind that if <strong>Reading Property</strong> is blank, the <em>implied</em> value is derived from <strong>Property</strong> and <strong>Time Unit</strong>.</td>
</tr>
<tr>
<td style="text-align: left;">Property Type</td>
<td style="text-align: left;">The datum property type to use.</td>
</tr>
<tr>
<td style="text-align: left;">Expression</td>
<td style="text-align: left;">The expression to evaluate. See <a href="#expressions">below</a> for more info.</td>
</tr>
<tr>
<td style="text-align: left;">Expression Language</td>
<td style="text-align: left;">The <a href="../../expressions/">expression language</a> to write <strong>Expression</strong> in.</td>
</tr>
</tbody>
</table>
<h2 id="filter-parameters"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.4</span> Filter parameters<a class="headerlink" href="#filter-parameters" title="Permanent link">¶</a></h2>
<p>When the virtual meter filter is applied to a given datum, it will generate the following filter
parameters, which will be available to other filters that are applied to the same datum <em>after</em> this
filter.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>{inputPropertyName}_diff</code></td>
<td style="text-align: left;">The difference between the current <strong>input</strong> property value and the previous input property value. The <code>{inputPropertyName}</code> part of the parameter name will be replaced by the actual input property name. For example <code>irradiance_diff</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><code>{meterPropertyName}_diff</code></td>
<td style="text-align: left;">The difference between the current <strong>output</strong> meter property value and the previous output meter property value. The <code>{meterPropertyName}</code> part of the parameter name will be replaced by the actual output meter property name. For example <code>irradianceHours_diff</code>.</td>
</tr>
</tbody>
</table>
<h2 id="virtual-meter-metadata"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.5</span> Virtual meter metadata<a class="headerlink" href="#virtual-meter-metadata" title="Permanent link">¶</a></h2>
<p>Virtual meters require keeping track of the meter reading value over time along with the previously
captured value. This plugin manages three <a href="../../local-state/">Local State</a> entities per virtual meter.
The entity keys are based on this pattern:</p>
<div class="highlight"><pre><span></span><code>vm:SOURCE_ID.METER_PROPERTY_NAME:METADATA_NAME
</code></pre></div>
<p>The CAPITALIZED parameters in that pattern represent:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>SOURCE_ID</code></td>
<td style="text-align: left;">The source ID of the datum being filtered.</td>
</tr>
<tr>
<td style="text-align: left;"><code>METER_PROPERTY_NAME</code></td>
<td style="text-align: left;">The <strong>output</strong> reading property name, either explicitly configured or derived from the input property name + time unit.</td>
</tr>
<tr>
<td style="text-align: left;"><code>METADATA_NAME</code></td>
<td style="text-align: left;">One of <code>date</code>, <code>value</code>, or <code>reading</code>, representing the millisecond Unix epoch timestamp, the input value, and the output reading of the virtual meter.</td>
</tr>
</tbody>
</table>
<p>For example, continuing the <code>irradianceHours</code> example evaulating against a datum with a source ID <code>meter/1</code>,
the local state entities managed by the virtual meter would look like:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Local State key</th>
<th style="text-align: left;">Type</th>
<th style="text-align: right;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>vm:meter/1.irradianceHours:date</code></td>
<td style="text-align: left;"><code>Int64</code></td>
<td style="text-align: right;"><code>1745877900000</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>vm:meter/1.irradianceHours:value</code></td>
<td style="text-align: left;"><code>Decimal</code></td>
<td style="text-align: right;"><code>1361</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>vm:meter/1.irradianceHours:reading</code></td>
<td style="text-align: left;"><code>Decimal</code></td>
<td style="text-align: right;"><code>12390980.1231</code></td>
</tr>
</tbody>
</table>
<h3 id="resetting-metadata"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.5.1</span> Resetting metadata<a class="headerlink" href="#resetting-metadata" title="Permanent link">¶</a></h3>
<p>You can manually update the local state entities associated with a virtual meter. The filter caches this information
internally, however, and will overwrite any changes you save, unless you follow these steps:</p>
<ol>
<li><strong>Disable the filter from executing.</strong> This can typically be accomplished by renaming its <strong>Service Name</strong> to
    something that does not match any referring components, such as adding a <code>__</code> prefix.</li>
<li><strong>Update the local state.</strong> Update the local state associated with the meter. You can change any of the values,
    but be sure to follow the same syntax as expected by the filter (for example the <code>:date</code> state must be a
    millisecond epoch date value).</li>
<li><strong>Restart SolarNode.</strong> This will force the cache to be cleared.</li>
<li><strong>Enable the filter.</strong> Once SolarNode is available again, undo whatever change you made in step 1, for example
    rename the <strong>Service Name</strong> back to its original value.</li>
</ol>
<h3 id="virtual-meter-legacy-metadata"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.5.2</span> Virtual meter legacy metadata<a class="headerlink" href="#virtual-meter-legacy-metadata" title="Permanent link">¶</a></h3>
<p>Virtual meters used to keep track of their metadata using the <a href="https://github.com/SolarNetwork/solarnetwork/wiki/SolarIn-API#node-datum-metadata-add">SolarNetwork datum metadata API</a>, storing
three metadata properties under a property key named for the virtual meter property name. For
example, continuing the <code>irradianceHours</code> example, an example set of datum metadata would look like:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"pm"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"irradianceHours"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">"vm-date"</span><span class="p">:</span><span class="w"> </span><span class="mi">123123123123</span><span class="p">,</span>
<span class="w">      </span><span class="nt">"vm-value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1361"</span><span class="p">,</span>
<span class="w">      </span><span class="nt">"vm-reading"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12390980.1231"</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>This metadata will be automatically copied to Local State entities, after which the metadata will not be
updated any more.</p>
<h2 id="expressions"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.6</span> Expressions<a class="headerlink" href="#expressions" title="Permanent link">¶</a></h2>
<p>Expressions can be configured to calculate the <strong>output</strong> meter datum property, instead of using the
default averaging algorithm. If an expression configuration exists with a <strong>Property</strong> that matches
a configured (or implied) meter configuration <strong>Reading Property</strong>, then the expression will be
invoked to generate the new meter reading value. See the <a href="../../expressions/">Expressions</a> guide for general
expression language reference.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is important to remember that the expression must calculate the next <em>meter reading</em> value.
Typically this means it will calculate some differential value based on the amount of time that
has elapsed and <strong>add</strong> that to the previous meter reading value.</p>
</div>
<h3 id="expression-root-object"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.6.1</span> Expression root object<a class="headerlink" href="#expression-root-object" title="Permanent link">¶</a></h3>
<p>The root object is a <a href="https://github.com/SolarNetwork/solarnetwork-node/blob/develop/net.solarnetwork.node.datum.filter.standard/src/net/solarnetwork/node/datum/filter/virt/VirtualMeterExpressionRoot.java">virtual meter expression object</a> that lets you
treat all datum properties, and filter parameters, as expression variables directly, along with
the following properties:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Property</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>config</code></td>
<td style="text-align: left;"><code>VirtualMeterConfig</code></td>
<td style="text-align: left;">A <a href="https://github.com/SolarNetwork/solarnetwork-node/blob/develop/net.solarnetwork.node.datum.filter.standard/src/net/solarnetwork/node/datum/filter/virt/VirtualMeterConfig.java"><code>VirtualMeterConfig</code></a> object for the virtual meter configuration the expression is evaluating for.</td>
</tr>
<tr>
<td style="text-align: left;"><code>datum</code></td>
<td style="text-align: left;"><code>GeneralNodeDatum</code></td>
<td style="text-align: left;">A <a href="https://github.com/SolarNetwork/solarnetwork-common/blob/develop/net.solarnetwork.common/src/net/solarnetwork/domain/datum/Datum.java"><code>Datum</code></a> object, populated with data from all property and virtual meter configurations.</td>
</tr>
<tr>
<td style="text-align: left;"><code>props</code></td>
<td style="text-align: left;"><code>Map&lt;String,Object&gt;</code></td>
<td style="text-align: left;">Simple Map based access to the properties in <code>datum</code>, and transform parameters, to simplify expressions.</td>
</tr>
<tr>
<td style="text-align: left;"><code>currDate</code></td>
<td style="text-align: left;"><code>long</code></td>
<td style="text-align: left;">The current datum timestamp, as a millisecond epoch number.</td>
</tr>
<tr>
<td style="text-align: left;"><code>prevDate</code></td>
<td style="text-align: left;"><code>long</code></td>
<td style="text-align: left;">The previous datum timestamp, as a millisecond epoch number.</td>
</tr>
<tr>
<td style="text-align: left;"><code>timeUnits</code></td>
<td style="text-align: left;"><code>decimal</code></td>
<td style="text-align: left;">A decimal number of the difference between <code>currDate</code> and <code>prevDate</code> in the virtual meter configuration's <strong>Time Unit</strong>, rounded to at most 12 decimal digits.</td>
</tr>
<tr>
<td style="text-align: left;"><code>currInput</code></td>
<td style="text-align: left;"><code>decimal</code></td>
<td style="text-align: left;">The current <strong>input</strong> property value.</td>
</tr>
<tr>
<td style="text-align: left;"><code>prevInput</code></td>
<td style="text-align: left;"><code>decimal</code></td>
<td style="text-align: left;">The previous <strong>input</strong> property value.</td>
</tr>
<tr>
<td style="text-align: left;"><code>inputDiff</code></td>
<td style="text-align: left;"><code>decimal</code></td>
<td style="text-align: left;">The difference between the <code>currInput</code> and <code>prevInput</code> values.</td>
</tr>
<tr>
<td style="text-align: left;"><code>prevReading</code></td>
<td style="text-align: left;"><code>decimal</code></td>
<td style="text-align: left;">The previous <strong>output</strong> meter property value.</td>
</tr>
</tbody>
</table>
<p>The following methods are available:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Function</th>
<th style="text-align: left;">Arguments</th>
<th style="text-align: left;">Result</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>has(name)</code></td>
<td style="text-align: left;"><code>String</code></td>
<td style="text-align: left;"><code>boolean</code></td>
<td style="text-align: left;">Returns <code>true</code> if a property named <code>name</code> is defined.</td>
</tr>
<tr>
<td style="text-align: left;"><code>timeUnits(scale)</code></td>
<td style="text-align: left;"><code>int</code></td>
<td style="text-align: left;"><code>decimal</code></td>
<td style="text-align: left;">Like the <code>timeUnits</code> property but rounded to a specific number of decimal digits.</td>
</tr>
</tbody>
</table>
<h3 id="expression-example-time-of-use-tariff-reading"><span class="enumerate-headings-plugin enumerate-heading-plugin">44.6.2</span> Expression example: time of use tariff reading<a class="headerlink" href="#expression-example-time-of-use-tariff-reading" title="Permanent link">¶</a></h3>
<p>Iagine you'd like to track a time-of-use cost associated with the energy readings captured by an
energy meter. The <a href="../tariff/">Time-based Tariff Datum Filter</a> filter could be used to add a
<code>tou</code> property to each datum, and then a virtual meter expression can be used to calculate a <code>cost</code>
reading property. The <code>cost</code> property will be an accumulating property like any meter reading, so
when SolarNetwork aggregates its value over time you will see the effective cost over each aggregate
time period.</p>
<p>Here is a screen shot of the settings used for this scenario (note how the <strong>Reading Property</strong> value
matches the Expression <strong>Property</strong> value):</p>
<figure>
<p><img alt="Virtual Meter Datum filter expression settings example" loading="lazy" src="../../../images/users/datum-filters/virtual-meter-filter-expression-settings-example%402x.png" width="699"/></p>
</figure>
<p>The important settings to note are:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Setting</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Virtual Meter - Property</td>
<td style="text-align: left;">The <strong>input</strong> datum property is set to <code>wattHours</code> because we want to track changes in this property over time.</td>
</tr>
<tr>
<td style="text-align: left;">Virtual Meter - Property Type</td>
<td style="text-align: left;">We use <code>Accumulating</code> here because that is the type of property <code>wattHours</code> is.</td>
</tr>
<tr>
<td style="text-align: left;">Virtual Meter - Reading Property</td>
<td style="text-align: left;">The <strong>output</strong> reading property name. This must match the <strong>Expression - Property</strong> setting.</td>
</tr>
<tr>
<td style="text-align: left;">Expression - Property</td>
<td style="text-align: left;">This must match the <strong>Virtual Meter - Reading Property</strong> we want to evaluate the expression for.</td>
</tr>
<tr>
<td style="text-align: left;">Expression - Property Type</td>
<td style="text-align: left;">Typically this should be <code>Accumulating</code> since we are generating a meter reading style property.</td>
</tr>
<tr>
<td style="text-align: left;">Expression - Expression</td>
<td style="text-align: left;">The expression to evaluate. This expression looks for the <code>tou</code> property and when found the meter reading is incremented by the difference between the current and previous input <code>wattHours</code> property values multiplied by <code>tou</code>. If <code>tou</code> is not available, then the previous meter reading value is returned (leaving the reading unchanged).</td>
</tr>
</tbody>
</table>
<p>Assuming a datum sample with properties like the following:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Property</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>tou</code></td>
<td style="text-align: left;"><code>11.00</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>currDate</code></td>
<td style="text-align: left;"><code>1621380669005</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>prevDate</code></td>
<td style="text-align: left;"><code>1621380609005</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>timeUnits</code></td>
<td style="text-align: left;"><code>0.016666666667</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>currInput</code></td>
<td style="text-align: left;"><code>6095574</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>prevInput</code></td>
<td style="text-align: left;"><code>6095462</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>inputDiff</code></td>
<td style="text-align: left;"><code>112</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>prevReading</code></td>
<td style="text-align: left;"><code>1022.782</code></td>
</tr>
</tbody>
</table>
<p>Then here are some example expressions and the results they would produce:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Expression</th>
<th style="text-align: left;">Result</th>
<th style="text-align: left;">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>inputDiff / 1000</code></td>
<td style="text-align: left;"><code>0.112</code></td>
<td style="text-align: left;">Convert the input Wh property difference to kWh.</td>
</tr>
<tr>
<td style="text-align: left;"><code>inputDiff / 1000 * tou</code></td>
<td style="text-align: left;"><code>1.232</code></td>
<td style="text-align: left;">Multiply the input kWh by the the $/kWh tariff value to calculate the cost for the elapsed time period.</td>
</tr>
<tr>
<td style="text-align: left;"><code>prevReading + (inputDiff / 1000 * tou)</code></td>
<td style="text-align: left;"><code>1,024.014</code></td>
<td style="text-align: left;">Add the additional cost to the previous meter reading value to reach the new meter value.</td>
</tr>
</tbody>
</table>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "navigation.indexes", "navigation.instant", "navigation.path", "navigation.tracking", "toc.follow"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
<script src="../../../js/open_in_new_tab.js"></script>
</body>
</html>